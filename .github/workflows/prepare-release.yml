name: prepare-release

on:
  workflow_dispatch:
    inputs:
      versionIncrement:
        description: 'The version increment. Allowed values are "major" and "minor".'
        required: true
        default: 'minor'     
jobs:
  prepare-release:
    runs-on: ubuntu-latest

    steps:
      - name: üß™ Validate arguments
        if: ${{ !contains(fromJson('["major","minor"]'), github.event.inputs.versionIncrement) }}
        run: |
          echo Unexpected versionIncrement specified. It be either "major" or "minor". ${{ github.event.inputs.versionIncrement }} is not a valid value.
          exit 1
    
      - name: üõí Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup CI GIT
        run: |
          git config user.name "github-actions[bot]"
          git config user.email noreply@github.com
      
      - name: ‚öôÔ∏è Setup GIT versioning
        uses: dotnet/nbgv@v0.4.0
        with:
          setAllVars: true
          
      - name: üõ†Ô∏è Increment version on mainline + create release branch
        run: |
          nbgv prepare-release --versionIncrement ${{ github.event.inputs.versionIncrement }}
          echo "version=$NBGV_MajorMinorVersion" >> $GITHUB_ENV
        
        # Only push to main if the release if from main. If it is not, it is likely a emergancy patch 
        # from another branch, in which case updates to version.json should not be propagated to
        # the main branch, as it might be newer.
      - name: ‚è© Push updates to main
        if: github.ref == 'refs/heads/main'
        run: git push origin main
        
      - name: ‚è© Push release branch to origin
        run: git push origin release/v$version
