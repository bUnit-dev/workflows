name: prepare-release
concurrency: 'prepare-release'

on:
  workflow_dispatch:
    inputs:
      versionIncrement:
        description: 'The version increment. Allowed values are "major" and "minor".'
        required: true
        default: 'minor'
        
jobs:  
  prepare-release:
    name: üöö Prepare new release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && contains(fromJson('["major","minor"]'), github.event.inputs.versionIncrement)
    steps:   
      - name: üõí Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Get Changelog Entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          version: Unreleased
          path: ./CHANGELOG.md
      
      - name: ‚òë Check that release contains changes
        if: steps.changelog_reader.outputs.changes == ''
        run: |
          echo "::error file=CHANGELOG.md::The unreleased section in the changelog is empty. Nothing to release."
          exit 1

      - name: ‚öôÔ∏è Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v3
        with:
          gpg-private-key: ${{ secrets.BUNIT_BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.BUNIT_BOT_GPG_KEY_PASSPHRASE }}
      
      - name: ‚öôÔ∏è Setup CI GIT
        run: |
          git config user.name "${{ steps.import_gpg.outputs.name }}"
          git config user.email ${{ steps.import_gpg.outputs.email }}
          git config --global user.signingkey ${{ steps.import_gpg.outputs.keyid }}
          git config --global commit.gpgsign true   
      
      - name: ‚öôÔ∏è Setup GIT versioning
        uses: dotnet/nbgv@v0.4.0
        with:
          setAllVars: true
          
      - name: üõ†Ô∏è Increment version.json on main + create release branch
        run: |
          nbgv prepare-release --versionIncrement ${{ github.event.inputs.versionIncrement }}
          echo "{MAIN_VERSION_COMMIT_MESSAGE}={git log --format=%B -n 1}" >> $GITHUB_ENV
          git reset --hard HEAD~1
          git reset --soft HEAD~1
          git commit -S -m "$MAIN_VERSION_COMMIT_MESSAGE"
          git checkout release/v$NBGV_MajorMinorVersion
          git reset --soft HEAD~1
          git commit -S -m "Set version '$NBGV_MajorMinorVersion'"
          git checkout main
          git merge -S -X ours release/v$NBGV_MajorMinorVersion
          
      - name: ‚è© Push version.json updates to main
        run: git push origin main
        
      - name: ‚è© Push release branch to origin
        run: git push origin release/v$NBGV_MajorMinorVersion

      - name: ‚è≠ Create pull request for release branch
        uses: thomaseizinger/create-pull-request@1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          head: release/v${{ env.NBGV_MajorMinorVersion }}
          base: stable
          title: Release of new ${{ github.event.inputs.versionIncrement }} version v${{ env.NBGV_MajorMinorVersion }}
          reviewers: ${{ github.actor }} # By default, we request a review from the person who triggered the workflow.
          body: |
            Hi @${{ github.actor }}
            
            This PR was created in response to a manual trigger of the [prepare-release workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
            
            Merging this PR will create a GitHub Release and push new packages to NuGet.
            
            **NOTE:** Only small fixes should be added to this PR at this point. If you need to make minor or major changes, close the PR and make those changes to ${{ github.ref }} instead, and run the prepare-release workflow again once you are done.
